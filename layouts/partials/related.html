{{/*
  Related pages: safe internal linking.
  - 3 from the same hub (if available)
  - 3 from other hubs
  Uses Hugo's shuffle to avoid the same set on every page.
*/}}

{{ $all := where .Site.RegularPages "Section" "pages" }}
{{ $current := .Permalink }}
{{ $hub := .Params.hub }}

{{ $sameHub := where $all "Params.hub" $hub }}
{{ $sameHub = where $sameHub "Permalink" "!=" $current }}

{{ $other := where $all "Params.hub" "!=" $hub }}
{{ $other = where $other "Permalink" "!=" $current }}

{{ $pickSame := first 3 (shuffle $sameHub) }}
{{ $pickOther := first 3 (shuffle $other) }}
{{ $rel := union $pickSame $pickOther }}

{{ if gt (len $rel) 0 }}
  <section class="related" aria-label="Related checks">
    <h2>Related checks</h2>
    <div class="related-grid">
      {{ range $rel }}
        <a class="related-card" href="{{ .RelPermalink }}">
          <div class="related-title">{{ .Title }}</div>
          {{ with .Params.summary }}<p class="related-desc">{{ . }}</p>{{ end }}
        </a>
      {{ end }}
    </div>
  </section>
{{ end }}
